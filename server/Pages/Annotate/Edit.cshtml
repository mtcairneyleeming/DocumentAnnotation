@page
@using System
@using DocumentAnnotation.Annotator
@using DocumentAnnotation.Extensions
@using DocumentAnnotation.Pages.Annotate
@using DocumentAnnotation.Pages.Partials
@using Serilog
@model DocumentAnnotation.Pages.Annotate.EditModel

@{
    ViewData["Title"] = Model.TextData.Title + ", " + Model.TextData.Author;
    ViewData["PageTitle"] = Model.TextData.Title + ", " + Model.TextData.Author;
    ViewData["PageSubtitle"] = $"Annotations on Book {Model.Book.Name}, Section {Model.Section.Name}";
}

@section Styles {
    @await Html.WebpackStylesAsync("page-annotate-edit")
}

@section Scripts {
    @await Html.WebpackScriptsAsync("page-annotate-edit")
    @Html.JsonDataBlock("annotations", Model.Annotator.Annotations)
    @Html.JsonDataBlock("annotation-colours", Model.Annotator.Annotations.ToDictionary(a => a.AnnotationId, a => Model.Annotator.GetColourName(a.AnnotationId)))
    @Html.JsonDataBlock("annotation-classes", Model.Annotator.Annotations.ToDictionary(a => a.AnnotationId, a => Model.Annotator.GetClassName(a.AnnotationId)))

    @await Html.WebpackScriptsAsync("page-text-view")
    @Html.JsonDataBlock("text-names", Model._loader.CloneNames(Model.FullText.Identifier))
    @Html.JsonDataBlock("info", new
    {
        bookId = Model.Book.Name,
        bookNumber = Model.BookNum,
        sectionId = Model.Section.Name,
        sectionNumber = Model.SectionNum,
        docAnnId = Model.DocAnn.DocumentAnnotationId
    })
}

@section Sidebar
{
    @await Html.PartialAsync("Partials/TextNavigation")
    @await Html.PartialAsync("Partials/DocumentDetails", Model.DocAnn)
    @await Html.PartialAsync("Partials/TextDetails", new TextDetails(Model.TextData, Model.Book.Name, Model.Section.Name))
}


<div id="container-fluid">
    <div id="foregroundContainer">
        <p id="document">
            @for (var i = 0; i < Model.Groups.Count; i++)
            {
                var group = Model.Groups[i];
                <span class="group" id="group@(i)">
                    @*for each word in the group*@
                    @for (var j = 0; j < group.Data.Count; j++)
                    {
                        var word = group.Data[j];
                        var classes = string.Join(' ', Model.Annotator.GetClasses(i, j).ToArray().Append("word"));
                        var ids = string.Join(",", Model.Annotator.GetAnnotationIds(i, j).ToArray());

                        <span id="@i-@j" data-ids="@ids" class="@classes">@word </span>
                    }
                </span>
                if (Model.Groups[i].AddNewLine)
                {
                    <br/>
                }
            }
            <span class="group" id="group@(Model.Groups.Count)"></span>

        </p>
        <div id="annotationContainer">
            <table class="table table-striped" id="annotationTable">
                <thead>
                <tr>
                    <th style="width: 1%"></th>
                    <th style="width: 20%">Title</th>
                    <th style="width: 59%">Description</th>
                    <th style="width: 20%"></th>
                </tr>
                </thead>
                <tbody>
                @for (var i = 0; i < Model.Annotator.Annotations.Count; i++)
                {
                    var ann = Model.Annotator.Annotations[i];
                    <tr id="annotation@(ann.AnnotationId)" data-ann-id="@ann.AnnotationId">
                        <td style="background-color: @Model.Annotator.GetColourName(ann.AnnotationId)" class="annotationTableColour"></td>
                        <td>@ann.Title</td>
                        <td>
                            <p>@ann.Body</p>
                        </td>
                        <td>
                            <a class="annotationEditLink btn btn-light">Edit</a>
                        </td>
                    </tr>
                }
                <tfoot>
                <tr id="annotation0" data-ann-id="0" class="newAnnotationRow">
                    <td style="background-color: #ffff00"></td>
                    <td>
                        <input type="text" class="form-control annTitle" placeholder="Annotation Title"
                               value="">
                    </td>
                    <td>
                        <textarea rows="2" placeholder="Your annotation" class="form-control annBody"></textarea>
                    </td>
                    <td>
                        <button class="btn btn-primary ann-new-save">Save</button>
                        <button class="btn btn-outline-danger ann-new-cancel">Cancel</button>
                    </td>
                </tr>
                </tfoot>
                </tbody>
            </table>
        </div>

    </div>
</div>
<div id="backgroundContainer">
    @*Must stay, to hold the canvas for drawing*@
</div>